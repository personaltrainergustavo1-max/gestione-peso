<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Cliente</title>
<link rel="stylesheet" href="styles.css">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <h1 data-i18n="dashboard">Dashboard Cliente</h1>
  <div class="toggles">
    <button id="themeToggle" data-i18n="theme">Tema</button>
    <button id="langToggle">EN/IT</button>
  </div>
  <div id="userInfo"></div>
  <button id="loginBtn" data-i18n="login">Login con Google</button>
  <button id="logoutBtn" data-i18n="logout" style="display:none;">Logout</button>
</header>

<main class="client-dashboard" style="display:none;">
  <div class="cards-container">
    <div class="card" data-type="weight">
      <h3 data-i18n="weight-progress">Andamento Peso</h3>
      <canvas id="weightChart"></canvas>
    </div>

    <div class="card" data-type="advices">
      <h3 data-i18n="advices">Consigli Alimentari</h3>
      <ul id="advicesList"></ul>
    </div>

    <div class="card" data-type="recipes">
      <h3 data-i18n="recipes">Ricette</h3>
      <ul id="recipesList"></ul>
    </div>

    <div class="card" data-type="photos">
      <h3 data-i18n="progress-photos">Foto Progressi</h3>
      <div id="photosContainer"></div>
    </div>
  </div>
</main>

<!-- Modal foto -->
<div id="photoModal" class="modal">
  <span class="close">&times;</span>
  <img class="modal-content" id="modalImg">
</div>

<script type="module">
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCE3yccgXo00Up-iekaAdgffOo_YyqXNuE",
  authDomain: "gestione-peso-1d758.firebaseapp.com",
  projectId: "gestione-peso-1d758",
  storageBucket: "gestione-peso-1d758.appspot.com",
  messagingSenderId: "121949363903",
  appId: "1:121949363903:web:4eb5f5a7131109ea8bb00a",
  measurementId: "G-WGBB30D5FK"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// UI elements
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userInfo = document.getElementById("userInfo");
const dashboard = document.querySelector(".client-dashboard");
const weightChartCtx = document.getElementById("weightChart").getContext("2d");
const advicesList = document.getElementById("advicesList");
const recipesList = document.getElementById("recipesList");
const photosContainer = document.getElementById("photosContainer");

// Modal
const modal = document.getElementById("photoModal");
const modalImg = document.getElementById("modalImg");
const modalClose = document.querySelector(".close");
modalClose.onclick = () => modal.style.display = "none";

// Login con Google
loginBtn.addEventListener("click", () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
});

logoutBtn.addEventListener("click", () => {
  auth.signOut();
});

// Theme toggle
const themeToggle = document.getElementById("themeToggle");
themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
});

// Language toggle
const langToggle = document.getElementById("langToggle");
langToggle.addEventListener("click", () => {
  const current = document.documentElement.lang;
  document.documentElement.lang = current === "it" ? "en" : "it";
  translatePage();
});

// Translation dictionary
const translations = {
  en: {
    "dashboard": "Client Dashboard",
    "theme": "Theme",
    "login": "Login with Google",
    "logout": "Logout",
    "weight-progress": "Weight Progress",
    "advices": "Nutrition Advices",
    "recipes": "Recipes",
    "progress-photos": "Progress Photos"
  },
  it: {
    "dashboard": "Dashboard Cliente",
    "theme": "Tema",
    "login": "Login con Google",
    "logout": "Logout",
    "weight-progress": "Andamento Peso",
    "advices": "Consigli Alimentari",
    "recipes": "Ricette",
    "progress-photos": "Foto Progressi"
  }
};

// Apply translations
function translatePage() {
  const lang = document.documentElement.lang;
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    el.textContent = translations[lang][key];
  });
}

// Auth state
auth.onAuthStateChanged(user => {
  if (user) {
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    dashboard.style.display = "block";
    userInfo.textContent = `Ciao, ${user.displayName}`;
    loadClientData(user.uid);
  } else {
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    dashboard.style.display = "none";
    userInfo.textContent = "";
  }
});

// Load data
async function loadClientData(uid) {
  // Weight data
  const weightsSnap = await db.collection(`users/${uid}/weights`).orderBy("date").get();
  const labels = [];
  const data = [];
  weightsSnap.forEach(doc => {
    labels.push(doc.data().date);
    data.push(doc.data().weight);
  });
  new Chart(weightChartCtx, {
    type: "line",
    data: { labels, datasets: [{ label: "Peso", data, borderColor: "#007bff", fill: false }] },
    options: { responsive:true, maintainAspectRatio:false }
  });

  // Advices
  const advicesSnap = await db.collection("advices").where("approved","==",true).get();
  advicesList.innerHTML = "";
  advicesSnap.forEach(doc => {
    const li = document.createElement("li");
    li.textContent = doc.data().text;
    advicesList.appendChild(li);
  });

  // Recipes
  const recipesSnap = await db.collection("recipes").where("approved","==",true).get();
  recipesList.innerHTML = "";
  recipesSnap.forEach(doc => {
    const li = document.createElement("li");
    li.textContent = doc.data().title;
    recipesList.appendChild(li);
  });

  // Photos
  const photosSnap = await db.collection(`users/${uid}/photos`).orderBy("date").get();
  photosContainer.innerHTML = "";
  photosSnap.forEach(doc => {
    const img = document.createElement("img");
    img.src = doc.data().url;
    img.classList.add("thumbnail");
    img.addEventListener("click", ()=> {
      modal.style.display = "block";
      modalImg.src = img.src;
    });
    photosContainer.appendChild(img);
  });
}

// Apply translations initially
translatePage();
</script>
</body>
</html>
