<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CoachPro — Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand"><div class="logo">CP</div><div><div class="title">CoachPro</div><div class="small">Client Dashboard</div></div></div>
      <div>
        <select id="langSelect"></select>
        <button id="themeBtn" class="btn-ghost">Theme</button>
        <button id="btnLogin" class="btn">Login</button>
        <button id="btnLogout" class="btn-ghost" style="display:none">Logout</button>
      </div>
    </div>

    <div id="authNotice" class="card">Accedi per vedere la tua dashboard</div>

    <div id="mainApp" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong id="greetName">—</strong><div class="small" id="greetEmail">—</div></div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="card">
            <label class="small">Inserisci peso (kg)</label>
            <input id="weightInput" type="number" placeholder="78.5" />
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="saveWeight" class="btn">Salva</button>
              <input id="photoFile" type="file" accept="image/*" />
              <button id="uploadPhoto" class="btn-ghost">Carica foto</button>
            </div>
            <div id="saveMsg" class="small"></div>
          </div>

          <div class="card">
            <h4>Andamento peso</h4>
            <canvas id="weightChart" height="150"></canvas>
            <div id="photoHover" style="position:relative"></div>
          </div>
        </div>

        <div class="col">
          <div class="card">
            <h4>Consigli alimentari</h4>
            <div id="advicesList" class="small">—</div>
          </div>

          <div class="card">
            <h4>Ricette consigliate</h4>
            <div id="recipesList" class="small">—</div>
          </div>
        </div>
      </div>
    </div>

    <footer class="small">© CoachPro</footer>
  </div>

  <script type="module">
    import * as S from "./script.js";

    // UI elements
    const btnLogin = document.getElementById("btnLogin"), btnLogout = document.getElementById("btnLogout");
    const authNotice = document.getElementById("authNotice"), mainApp = document.getElementById("mainApp");
    const greetName = document.getElementById("greetName"), greetEmail = document.getElementById("greetEmail");
    const weightInput = document.getElementById("weightInput"), saveWeightBtn = document.getElementById("saveWeight");
    const saveMsg = document.getElementById("saveMsg");
    const uploadPhotoBtn = document.getElementById("uploadPhoto"), photoFile = document.getElementById("photoFile");
    const advicesList = document.getElementById("advicesList"), recipesList = document.getElementById("recipesList");

    // theme + lang quick init
    const langSelect = document.getElementById("langSelect"), themeBtn = document.getElementById("themeBtn");
    ["it","en"].forEach(l => { const o=document.createElement("option"); o.value=l; o.textContent=l.toUpperCase(); langSelect.appendChild(o); });
    langSelect.value = localStorage.getItem("cp_lang") || "it";
    langSelect.onchange = ()=> localStorage.setItem("cp_lang", langSelect.value);
    themeBtn.onclick = ()=> {
      const cur = document.documentElement.getAttribute("data-theme") || "light";
      const next = cur==="dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next); localStorage.setItem("cp_theme", next);
    };

    // chart
    let chart = null, photosCache = [];

    function renderChart(weights){
      const labels = weights.map(w => new Date((w.ts?.seconds||0)*1000).toLocaleDateString());
      const data = weights.map(w => w.value);
      if(chart) { chart.data.labels = labels; chart.data.datasets[0].data = data; chart.update(); return; }
      const ctx = document.getElementById("weightChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: "Peso (kg)", data, tension:0.25, borderColor:'#14b8ff', backgroundColor:'rgba(20,184,166,0.06)'}] },
        options: {
          responsive:true,
          onHover: (evt, elements) => {
            if(elements.length>0){ const idx = elements[0].index; showPhotoForIndex(idx, weights); } else hideHoverPhoto();
          }
        }
      });
    }

    function showPhotoForIndex(index, weights){
      const w = weights[index];
      if(!w) return;
      const tsMs = (w.ts?.seconds||0)*1000;
      const p = S.findNearestPhotoForTs(photosCache, tsMs);
      if(!p){ hideHoverPhoto(); return; }
      let el = document.getElementById("floatPhoto");
      if(!el){ el = document.createElement("img"); el.id="floatPhoto"; el.className="float-photo"; document.body.appendChild(el); }
      el.src = p.url;
      el.style.display = "block";
      el.style.left = (window.innerWidth - 220) + "px";
      el.style.top = "120px";
    }
    function hideHoverPhoto(){ const el=document.getElementById("floatPhoto"); if(el) el.style.display="none"; }

    // AUTH handlers
    btnLogin.onclick = async ()=> { try{ await S.loginWithGoogle(); }catch(e){ alert(e.message || e); } };
    btnLogout.onclick = async ()=> { await S.logout(); };

    S.auth.onAuthStateChanged(async user => {
      if(!user){ authNotice.style.display="block"; mainApp.style.display="none"; btnLogin.style.display="inline-block"; btnLogout.style.display="none"; return; }
      authNotice.style.display="none"; mainApp.style.display="block"; btnLogin.style.display="none"; btnLogout.style.display="inline-block";
      greetName.textContent = user.displayName || "Client"; greetEmail.textContent = user.email || "";
      // load data
      const uid = user.uid;
      const weights = await S.getUserWeights(uid);
      photosCache = await S.getUserPhotos(uid);
      renderChart(weights);
      // advices + recipes approved
      const adv = await S.getApprovedAdvices(); advicesList.innerHTML = adv.map(a=>`<div class="list-item"><div><strong>${a.title}</strong><div class="small">${a.category}</div></div></div>`).join('') || "—";
      const rec = await S.getApprovedRecipes(); recipesList.innerHTML = rec.map(r=>`<div class="list-item"><div><strong>${r.food}</strong><div class="small">${(r.generatedText||'').slice(0,140)}...</div></div></div>`).join('') || "—";
    });

    // save weight
    saveWeightBtn.onclick = async ()=> {
      const v = Number(weightInput.value);
      if(!v){ saveMsg.textContent = "Inserisci un valore valido"; return; }
      await S.saveWeightForUser(S.auth.currentUser.uid, v);
      saveMsg.textContent = "Salvato";
      weightInput.value = "";
      const weights = await S.getUserWeights(S.auth.currentUser.uid);
      renderChart(weights);
    };

    // upload photo
    uploadPhotoBtn.onclick = async ()=>{
      const f = photoFile.files[0]; if(!f) return alert("Seleziona un file");
      try{
        uploadPhotoBtn.disabled=true; uploadPhotoBtn.textContent="Uploading...";
        const out = await S.uploadPhotoToWorker(f);
        await S.savePhotoMetaForUser(S.auth.currentUser.uid, { url: out.url, key: out.key, filename: f.name, uploadedAt: serverTimestamp() });
        photosCache = await S.getUserPhotos(S.auth.currentUser.uid);
        alert("Foto caricata");
      }catch(e){ alert("Upload failed: " + e.message); } finally { uploadPhotoBtn.disabled=false; uploadPhotoBtn.textContent="Carica foto"; }
    };

  </script>
</body>
</html>
