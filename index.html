<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CoachPro — Gestione Peso (Client)</title>

  <!-- Fonts & libraries -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#0b2540; --muted:#5b6b77; --accent:#0ea5ff;
      --radius:12px;
    }
    [data-theme="dark"] {
      --bg:#07121a; --card:#0b1a23; --text:#e6f3fb; --muted:#8aa3b2; --accent:#14b8ff;
    }

    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{background:var(--bg);color:var(--text);margin:0;padding:20px;min-height:100vh}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#036);display:flex;align-items:center;justify-content:center;color:#012;font-weight:800}
    .title{font-weight:700}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 16px rgba(0,0,0,0.06);margin-bottom:12px;border:1px solid rgba(2,6,23,0.04)}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .btn{background:var(--accent);color:#022;padding:10px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.08);padding:8px 10px;border-radius:8px;cursor:pointer}
    input, textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:transparent;color:var(--text)}
    .small{font-size:13px;color:var(--muted)}
    .thumb{width:120px;height:120px;object-fit:cover;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

    /* responsive */
    @media(max-width:880px){ .row{flex-direction:column} .thumb{width:100px;height:100px} }
    /* language switch */
    .controls{display:flex;gap:8px;align-items:center}
    .lang-btn{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:6px 8px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body data-theme="dark">
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">CP</div>
        <div>
          <div class="title">CoachPro</div>
          <div class="small" id="subtitle">Gestione Peso & Progress</div>
        </div>
      </div>

      <div class="controls">
        <label class="small" for="langSelect">EN / IT</label>
        <select id="langSelect" class="lang-btn small" aria-label="Language">
          <option value="it">IT</option>
          <option value="en">EN</option>
        </select>

        <label class="small" style="margin-left:8px">Day / Night</label>
        <input id="themeToggle" type="checkbox" aria-label="Theme toggle" />
      </div>
    </header>

    <!-- Auth card -->
    <div id="authCard" class="card">
      <h3 id="authTitle">Accedi</h3>
      <p class="small" id="authDesc">Accedi con Google per gestire le tue foto e i progressi</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button id="btnGoogle" class="btn">Sign in with Google</button>
        <button id="btnSignOut" class="btn-ghost" style="display:none">Sign out</button>
      </div>
    </div>

    <!-- App -->
    <div id="app" style="display:none">

      <div class="row">
        <div class="col">
          <div class="card">
            <h4 id="profileGreeting">Benvenuto</h4>
            <div class="small" id="emailLabel">—</div>

            <div style="margin-top:12px">
              <label class="small" id="weightLabel">Peso attuale (kg)</label>
              <input id="inputWeight" type="number" placeholder="es. 78.5" />
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="saveWeightBtn" class="btn">Salva peso</button>
                <button id="calcETA" class="btn-ghost">Calcola ETA</button>
              </div>
            </div>
            <div id="etaOut" class="small" style="margin-top:8px"></div>
          </div>

          <div class="card">
            <h4 id="chartTitle">Andamento Peso</h4>
            <canvas id="weightChart" height="120"></canvas>
          </div>

          <div class="card">
            <h4 id="photoTitle">Foto progresso</h4>
            <input id="photoInput" type="file" accept="image/*" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="uploadPhotoBtn" class="btn">Carica foto</button>
              <button id="refreshPhotos" class="btn-ghost">Aggiorna</button>
            </div>
            <div id="photosGrid" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px"></div>
          </div>

        </div>

        <aside style="width:360px">
          <div class="card">
            <h4 id="aiTitle">Assistente Virtuale</h4>
            <textarea id="aiQuestion" rows="4" placeholder="Ask nutrition / plan questions"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="aiSend" class="btn">Invia</button>
              <button id="aiClear" class="btn-ghost">Clear</button>
            </div>
            <div id="aiAnswer" class="small" style="margin-top:10px;white-space:pre-wrap"></div>
          </div>

          <div class="card">
            <h4 id="usdaTitle">Ricerca alimenti (USDA)</h4>
            <input id="usdaQuery" placeholder="es. chicken, apple" />
            <button id="usdaSearch" class="btn" style="margin-top:8px">Cerca</button>
            <div id="usdaOut" class="small" style="margin-top:10px;max-height:220px;overflow:auto"></div>
          </div>
        </aside>
      </div>

    </div>

    <footer class="small">Disclaimer: contenuti informativi. Per patologie contatta un professionista.</footer>
  </div>

  <!-- Firebase modular SDK (imports used in module below) -->
  <script type="module">
  /*******************************
   * CONFIG & CONSTANTS
   *******************************/
  // Your Firebase config (public client config) - you provided this earlier
  const firebaseConfig = {
    apiKey: "AIzaSyCE3yccgXo00Up-iekaAdgffOo_YyqXNuE",
    authDomain: "gestione-peso-1d758.firebaseapp.com",
    projectId: "gestione-peso-1d758",
    storageBucket: "gestione-peso-1d758.firebasestorage.app",
    messagingSenderId: "121949363903",
    appId: "1:121949363903:web:4eb5f5a7131109ea8bb00a",
    measurementId: "G-WGBB30D5FK"
  };

  // Your worker endpoint (proxy) - confirmed by you
  const WORKER_URL = "https://gino.personaltrainergustavo1.workers.dev";

  // Language strings (IT / EN)
  const L = {
    it: {
      signIn: "Accedi con Google",
      signOut: "Esci",
      welcome: "Benvenuto",
      uploadPhoto: "Carica foto",
      searching: "Caricamento...",
      uploaded: "Foto caricata",
      uploadFail: "Upload fallito",
      weightLabel: "Peso attuale (kg)",
      chartTitle: "Andamento Peso",
      photoTitle: "Foto progresso",
      aiTitle: "Assistente Virtuale",
      usdaTitle: "Ricerca alimenti (USDA)",
      authDesc: "Accedi con Google per gestire le tue foto e i progressi"
    },
    en: {
      signIn: "Sign in with Google",
      signOut: "Sign out",
      welcome: "Welcome",
      uploadPhoto: "Upload photo",
      searching: "Uploading...",
      uploaded: "Photo uploaded",
      uploadFail: "Upload failed",
      weightLabel: "Current weight (kg)",
      chartTitle: "Weight trend",
      photoTitle: "Progress photos",
      aiTitle: "Virtual Assistant",
      usdaTitle: "Food search (USDA)",
      authDesc: "Sign in with Google to manage photos & progress"
    }
  };

  /*******************************
   * IMPORTS: Firebase modular SDK
   *******************************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  // init firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /*******************************
   * UI ELEMENTS
   *******************************/
  const authCard = document.getElementById('authCard');
  const appDiv = document.getElementById('app');
  const btnGoogle = document.getElementById('btnGoogle');
  const btnSignOut = document.getElementById('btnSignOut');
  const profileGreeting = document.getElementById('profileGreeting');
  const emailLabel = document.getElementById('emailLabel');
  const inputWeight = document.getElementById('inputWeight');
  const saveWeightBtn = document.getElementById('saveWeightBtn');
  const calcETABtn = document.getElementById('calcETA');
  const etaOut = document.getElementById('etaOut');
  const weightChartCtx = document.getElementById('weightChart');
  const photoInput = document.getElementById('photoInput');
  const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
  const photosGrid = document.getElementById('photosGrid');
  const refreshPhotosBtn = document.getElementById('refreshPhotos');
  const aiQuestion = document.getElementById('aiQuestion');
  const aiSend = document.getElementById('aiSend');
  const aiAnswer = document.getElementById('aiAnswer');
  const aiClear = document.getElementById('aiClear');
  const usdaQuery = document.getElementById('usdaQuery');
  const usdaSearch = document.getElementById('usdaSearch');
  const usdaOut = document.getElementById('usdaOut');
  const langSelect = document.getElementById('langSelect');
  const themeToggle = document.getElementById('themeToggle');
  const subtitle = document.getElementById('subtitle');
  const authTitle = document.getElementById('authTitle');
  const authDesc = document.getElementById('authDesc');

  // local state
  let currentUser = null;
  let chart = null;

  /*******************************
   * THEME + LANGUAGE INIT
   *******************************/
  (function initUIsettings(){
    const theme = localStorage.getItem('cp_theme') || 'dark';
    document.body.setAttribute('data-theme', theme === 'dark' ? 'dark' : 'light');
    themeToggle.checked = (theme === 'dark');

    const lang = localStorage.getItem('cp_lang') || 'it';
    langSelect.value = lang;
    applyLang(lang);
  })();

  themeToggle.addEventListener('change', ()=>{
    const t = themeToggle.checked ? 'dark' : 'light';
    document.body.setAttribute('data-theme', t === 'dark' ? 'dark' : 'light');
    localStorage.setItem('cp_theme', t);
  });

  langSelect.addEventListener('change', (e)=>{
    const v = e.target.value;
    localStorage.setItem('cp_lang', v);
    applyLang(v);
  });

  function applyLang(code){
    const s = L[code];
    btnGoogle.textContent = s.signIn;
    btnSignOut.textContent = s.signOut;
    profileGreeting.textContent = s.welcome;
    document.getElementById('photoTitle').innerText = s.photoTitle;
    document.getElementById('chartTitle').innerText = s.chartTitle;
    document.getElementById('aiTitle').innerText = s.aiTitle;
    document.getElementById('usdaTitle').innerText = s.usdaTitle;
    authTitle.textContent = s.signIn;
    authDesc.textContent = s.authDesc;
    document.getElementById('weightLabel').innerText = s.weightLabel;
  }

  /*******************************
   * AUTH
   *******************************/
  const provider = new GoogleAuthProvider();

  btnGoogle.addEventListener('click', async ()=>{
    try{
      const res = await signInWithPopup(auth, provider);
      // token is handled in onAuthStateChanged
    }catch(e){ alert(e.message || e); }
  });

  btnSignOut.addEventListener('click', async ()=>{
    await signOut(auth);
  });

  onAuthStateChanged(auth, async user=>{
    if(!user){
      currentUser = null;
      authCard.style.display = 'block';
      appDiv.style.display = 'none';
      btnSignOut.style.display = 'none';
      return;
    }
    currentUser = user;
    authCard.style.display = 'none';
    appDiv.style.display = 'block';
    btnSignOut.style.display = 'inline-block';
    profileGreeting.innerText = (localStorage.getItem('cp_lang') === 'en') ? `Welcome, ${user.displayName || ''}` : `Benvenuto, ${user.displayName || ''}`;
    emailLabel.innerText = user.email;
    await refreshAll();
  });

  /*******************************
   * UTILS: get id token
   *******************************/
  async function getIdToken(){
    if(!currentUser) return null;
    return await currentUser.getIdToken(/* forceRefresh */ true);
  }

  /*******************************
   * UPLOAD PHOTO → Worker → R2
   *******************************/
  uploadPhotoBtn.addEventListener('click', async ()=>{
    if(!photoInput.files.length) return alert('Select a photo first');
    const file = photoInput.files[0];
    try{
      uploadPhotoBtn.disabled = true;
      uploadPhotoBtn.textContent = L[localStorage.getItem('cp_lang') || 'it'].searching || 'Uploading...';

      const idToken = await getIdToken();
      const fd = new FormData();
      fd.append('file', file);
      fd.append('uid', currentUser.uid);

      const res = await fetch(`${WORKER_URL}/upload`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + idToken },
        body: fd
      });
      const json = await res.json();
      if(!json.ok && !json.success) throw new Error(json.error || 'upload failed');

      // try to get URL: worker may return url or only key
      const url = json.url || `${WORKER_URL}/file/${encodeURIComponent(json.key || json.key)}`;
      alert(L[localStorage.getItem('cp_lang') || 'it'].uploaded || 'Uploaded');
      await savePhotoMeta(url, json.key || json.key);
      await refreshPhotos();
    }catch(e){
      console.error(e);
      alert(L[localStorage.getItem('cp_lang') || 'it'].uploadFail || 'Upload failed');
    } finally {
      uploadPhotoBtn.disabled = false;
      uploadPhotoBtn.textContent = L[localStorage.getItem('cp_lang') || 'it'].uploadPhoto || 'Upload photo';
    }
  });

  // save metadata in Firestore users/{uid}/photos doc
  async function savePhotoMeta(url, key){
    try{
      const col = collection(db, 'users', currentUser.uid, 'photos');
      await addDoc(col, { url, key, filename: key.split('/').pop(), uploadedAt: Timestamp.now() });
    }catch(e){ console.error('save meta', e); }
  }

  // refresh photos grid
  async function refreshPhotos(){
    photosGrid.innerHTML = '';
    try{
      const snaps = await getDocs(query(collection(db,'users',currentUser.uid,'photos'), orderBy('uploadedAt','desc')));
      snaps.forEach(s=>{
        const d = s.data();
        const div = document.createElement('div'); div.style.margin='6px';
        const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='btn-ghost small';
        delBtn.onclick = async ()=>{ 
          // delete via worker and then remove doc
          const idToken = await getIdToken();
          const resp = await fetch(`${WORKER_URL}/delete`, {
            method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+idToken }, body: JSON.stringify({ key: d.key })
          });
          const j = await resp.json();
          if(j.ok){ await s.ref.delete(); refreshPhotos(); }
        };
        div.innerHTML = `<img src="${d.url}" class="thumb"><div class="small">${(d.filename || '').slice(0,24)}</div>`;
        div.appendChild(delBtn);
        photosGrid.appendChild(div);
      });
    }catch(e){ console.error(e); }
  }

  refreshPhotosBtn.addEventListener('click', refreshPhotos);

  /*******************************
   * WEIGHT: save/read + chart
   *******************************/
  importChart();

  async function importChart(){
    // Chart.js already loaded as global Chart
    // create empty chart
    chart = new Chart(weightChartCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Peso (kg)', data: [], borderColor:'#14b8ff', backgroundColor:'rgba(20,184,166,0.08)', tension:0.25 }]},
      options: { responsive:true, plugins:{legend:{display:false}}}
    });
  }

  saveWeightBtn.addEventListener('click', async ()=>{
    const v = Number(inputWeight.value);
    if(!v) return alert('Insert a valid weight');
    try{
      const col = collection(db,'users',currentUser.uid,'weights');
      await addDoc(col, { value: v, ts: Timestamp.now() });
      inputWeight.value = '';
      await refreshWeights();
    }catch(e){ console.error(e); }
  });

  async function refreshWeights(){
    try{
      const snaps = await getDocs(query(collection(db,'users',currentUser.uid,'weights'), orderBy('ts','asc')));
      const labels = [];
      const data = [];
      snaps.forEach(s=>{
        const d = s.data();
        labels.push(new Date(d.ts.seconds*1000).toLocaleDateString());
        data.push(d.value);
      });
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update();
    }catch(e){ console.error(e); }
  }

  calcETABtn.addEventListener('click', async ()=>{
    try{
      const snaps = await getDocs(query(collection(db,'users',currentUser.uid,'weights'), orderBy('ts','asc')));
      const vals = snaps.docs.map(d=>d.data().value);
      if(vals.length<2) return alert('Need at least 2 entries');
      const last = vals[vals.length-1], first = vals[0];
      const weeks = Math.max(1, vals.length-1);
      const ratePerWeek = (last - first) / weeks;
      const target = prompt('Inserisci peso obiettivo (kg)');
      if(!target) return;
      const remaining = target - last;
      if(Math.abs(ratePerWeek) < 0.01) return alert('Trend troppo basso per stimare');
      const estWeeks = Math.round(remaining / ratePerWeek);
      etaOut.innerText = (estWeeks>0? estWeeks + ' settimane':'Obiettivo raggiunto o trend inverso');
    }catch(e){ console.error(e); }
  });

  /*******************************
   * AI + USDA (via Worker)
   *******************************/
  aiSend.addEventListener('click', async ()=>{
    const q = aiQuestion.value.trim();
    if(!q) return;
    aiAnswer.innerText = 'Processing...';
    try{
      const payload = { messages:[{ role:'user', content:q }] };
      const res = await fetch(`${WORKER_URL}/api/chat`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      const j = await res.json();
      const out = j?.choices?.[0]?.message?.content ?? j?.choices?.[0]?.text ?? JSON.stringify(j);
      aiAnswer.innerText = out;
    }catch(e){ aiAnswer.innerText = 'AI error: ' + e.message; }
  });

  aiClear.addEventListener('click', ()=>{ aiQuestion.value=''; aiAnswer.innerText=''; });

  usdaSearch.addEventListener('click', async ()=>{
    const q = usdaQuery.value.trim();
    if(!q) return;
    usdaOut.innerText = 'Searching...';
    try{
      const res = await fetch(`${WORKER_URL}/api/usda?q=${encodeURIComponent(q)}`);
      const j = await res.json();
      if(j.foods && j.foods.length){
        usdaOut.innerHTML = j.foods.slice(0,6).map(f=>{
          const cal = (f.foodNutrients||[]).find(n=>/Energy/i.test(n.nutrientName));
          return `<div style="margin-bottom:8px"><strong>${f.description}</strong><div class="small">Calories: ${cal?.value || 'n/a'} ${cal?.unitName || ''}</div></div>`;
        }).join('');
      } else usdaOut.innerText = 'No results';
    }catch(e){ usdaOut.innerText = 'Error: ' + e.message; }
  });

  /*******************************
   * REFRESH ALL on login
   *******************************/
  async function refreshAll(){
    await refreshWeights();
    await refreshPhotos();
  }

  /*******************************
   * FINAL: small helpers for translations
   *******************************/
  // nothing else
  </script>
</body>
</html>
