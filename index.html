<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Peso Clienti</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: Arial; margin: 0; padding: 20px; background-color: var(--bg); color: var(--text); }
:root { --bg:#ffffff; --text:#000000; }
.dark { --bg:#1e1e1e; --text:#f0f0f0; }
button, input, select { padding: 8px; margin: 5px; border-radius: 6px; border:1px solid #777; }
.card { border:1px solid #444; padding:15px; border-radius:8px; margin-bottom:20px; }
#chartContainer { width:100%; max-width:600px; }
.chat-box { border:1px solid #555; padding:10px; height:200px; overflow:auto; background:#fff; color:#000; }
.dark .chat-box { background:#333; color:#fff; }
</style>
</head>
<body id="body">
<h2>Dashboard Cliente</h2>
<button onclick="toggleDark()">Modalit√† Light/Dark</button>

<div class="card">
  <h3>Inserisci peso</h3>
  <input id="pesoInput" type="number" step="0.1" placeholder="Peso">
  <button onclick="addPeso()">Aggiungi</button>
</div>

<div class="card" id="chartContainer">
  <h3>Andamento Peso</h3>
  <canvas id="pesoChart"></canvas>
</div>

<div class="card">
  <h3>Genera Dieta</h3>
  <label>Obiettivo:</label>
  <select id="goal">
    <option value="loss">Perdita peso</option>
    <option value="gain">Aumento massa</option>
  </select><br>
  <label>Intolleranze:</label>
  <input id="intolleranze" placeholder="es. lattosio, glutine"><br>
  <input id="accept" type="checkbox"> Accetto disclaimer<br>
  <button onclick="generateDietPDF()">Scarica Dieta PDF</button>
</div>

<div class="card">
  <h3>Assistente Virtuale</h3>
  <div class="chat-box" id="chat"></div>
  <input id="msg" placeholder="Scrivi una domanda...">
  <button onclick="sendMsg()">Invia</button>
</div>

<script>
const key = "gp_data_chart";
let data = JSON.parse(localStorage.getItem(key) || "[]");
function save(){ localStorage.setItem(key, JSON.stringify(data)); renderChart(); }
function addPeso(){ const v = parseFloat(document.getElementById('pesoInput').value); if(!v) return; data.push({date:new Date().toLocaleDateString(), peso:v}); save(); }
let chart;
function renderChart(){
  const ctx = document.getElementById('pesoChart');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: data.map(x=>x.date), datasets: [{ label:"Peso", data: data.map(x=>x.peso), borderWidth:2 }] }
  });
}
renderChart();
function toggleDark(){ document.body.classList.toggle("dark"); }

async function generateDietPDF(){
  if(!document.getElementById("accept").checked){ alert("Accetta il disclaimer"); return; }
  const { jsPDF } = window.jspdf; const doc = new jsPDF();
  const goal = document.getElementById("goal").value;
  const intol = document.getElementById("intolleranze").value;
  const text = `Piano Alimentare\nObiettivo: ${goal==="loss"?"Perdita Peso":"Aumento Massa"}\nIntolleranze: ${intol}\n\nColazione: Avena, frutta, proteine\nPranzo: Pollo, riso, verdure\nCena: Pesce, patate, insalata\nSpuntini: Yogurt greco, frutta secca\n*Placeholder USFCD`;
  doc.text(text, 10, 10);
  doc.save("piano_dieta.pdf");
}

const faq = {
  "quante calorie": "Dipende dal tuo metabolismo e dal piano fornito.",
  "come dimagrire": "Calorie controllate, proteine adeguate, movimento costante.",
  "come aumentare massa": "Surplus calorico, allenamento forza, proteine adeguate."
};
function sendMsg(){
  const box = document.getElementById('chat');
  const msg = document.getElementById('msg').value.toLowerCase();
  if(!msg) return;
  box.innerHTML += "<div><b>Tu:</b> "+msg+"</div>";
  let reply = "Non ho capito, prova a riformulare.";
  for(const q in faq) if(msg.includes(q)) reply = faq[q];
  box.innerHTML += "<div><b>AI:</b> "+reply+"</div>";
  box.scrollTop = box.scrollHeight;
  document.getElementById('msg').value="";
}
</script>
</body>
</html>